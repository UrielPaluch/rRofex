<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Powering rRofex with Shiny • rRofex</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Powering rRofex with Shiny">
<meta property="og:description" content="A brief introduction of using Shiny with rRofex.">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@augustohassel">
<meta name="twitter:site" content="@matba_rofex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rRofex</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/shiny-and-rrofex.html">Powering rRofex with Shiny</a>
    </li>
    <li>
      <a href="../articles/spread-analysis.html">Spread Analysis using rRofex</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/matbarofex/rRofex/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="shiny-and-rrofex_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Powering rRofex with Shiny</h1>
                        <h4 class="author">Augusto Hassel</h4>
            
            <h4 class="date">2020-07-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/matbarofex/rRofex/blob/master/vignettes/shiny-and-rrofex.Rmd"><code>vignettes/shiny-and-rrofex.Rmd</code></a></small>
      <div class="hidden name"><code>shiny-and-rrofex.Rmd</code></div>

    </div>

    
    
<p>This post is not an attempt to explain in detail how to build a Shiny application, rather it is to show a few interesting things that one can build using Shiny in conjuction with the rRofex library.</p>
<p>I hope that this serves as a starting point and an insipiration for others to build their own solutions.</p>
<div id="the-applicaction" class="section level3">
<h3 class="hasAnchor">
<a href="#the-applicaction" class="anchor"></a>The applicaction</h3>
<p>The full application can be run either locally using a Gist from GitHub or one can access the online version:</p>
<ul>
<li>
<strong>Locally</strong>. In your R console, you just have to run the following code:</li>
</ul>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="kw pkg">shiny</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/runUrl.html">runGist</a></span>(<span class="kw">gist</span> <span class="kw">=</span> <span class="st">"https://gist.github.com/augustohassel/4eea614f80a8bbc548b2b4c3c5edd7c3"</span>)</pre></body></html></div>
<ul>
<li>
<strong>Online</strong>. If you want to test the application without having to run it locally, you can use this <a href="https://demo.hasselpunk.com/rRofex/">link</a> or take a peek just right down here.</li>
</ul>
<div style="height: 45vh;">
<iframe src="https://demo.hasselpunk.com/rRofex/" class="shiny-app" style="overflow: hidden;width: 165%;height: 700px;-ms-zoom: 0.85;-moz-transform: scale(0.85);-moz-transform-origin: 0px 0;-o-transform: scale(0.85);-o-transform-origin: 0 0;-webkit-transform: scale(0.6);-webkit-transform-origin: 0 0;">
</iframe>
</div>
<div id="features" class="section level4">
<h4 class="hasAnchor">
<a href="#features" class="anchor"></a>Features</h4>
<p>The main features of this application are:</p>
<ol style="list-style-type: decimal">
<li>Login into any endpoint allowed within the API</li>
<li>Real time plotting using websocket protocol</li>
<li>Real time compute of CCL using REST protocol</li>
<li>A primer on algorithmic trading using R and websocket</li>
</ol>
<p><strong>I will describe briefly each feature pointing out some relevant code for a better understanding.</strong></p>
<div id="login" class="section level5">
<h5 class="hasAnchor">
<a href="#login" class="anchor"></a><strong>1. Login</strong>
</h5>
<p>At the very begining of the server function one can found a reactive value called <code>global_connection</code>. Each session will have it’s own connection, so we don’t have to worry about mixing information across sessions.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">global_connection</span> <span class="kw">&lt;-</span> <span class="fu">reactiveValues</span>(<span class="kw">conn</span> <span class="kw">=</span> <span class="kw">NULL</span>)</pre></body></html></div>
<p>Once we login using the <a href="https://matbarofex.github.io/rRofex/reference/trading_login.html" target="_blank">trading_login()</a> function, the created object will be stored inside <code>global_connection$conn</code>.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/conditions.html">withCallingHandlers</a></span>({
  <span class="no">global_connection</span>$<span class="no">conn</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/trading_login.html">trading_login</a></span>(<span class="kw">username</span> <span class="kw">=</span> <span class="no">input</span>$<span class="no">username</span>, <span class="kw">password</span> <span class="kw">=</span> <span class="no">input</span>$<span class="no">password</span>, <span class="kw">base_url</span> <span class="kw">=</span> <span class="no">input</span>$<span class="no">base_url</span>)
  },
  <span class="kw">message</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">m</span>) {<span class="no">output</span>$<span class="no">console_login</span> <span class="kw">&lt;-</span> <span class="fu">renderPrint</span>({<span class="no">m</span>$<span class="no">message</span>})},
  <span class="kw">warning</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">m</span>) {<span class="no">output</span>$<span class="no">console_login</span> <span class="kw">&lt;-</span> <span class="fu">renderPrint</span>({<span class="no">m</span>$<span class="no">message</span>})}
  )</pre></body></html></div>
<p>Every connection object will be destroyed at the end of each session.</p>
</div>
<div id="plotting-data-using-a-websokcet-connection" class="section level5">
<h5 class="hasAnchor">
<a href="#plotting-data-using-a-websokcet-connection" class="anchor"></a><strong>2. Plotting data using a websokcet connection</strong>
</h5>
<p>In the same maner as with th login, here we start by creating a reactive value that will contain the final market data, called <code>global_graficos</code>, and an environment created with <code><a href="https://rlang.r-lib.org/reference/env.html">rlang::env()</a></code> in which we will store each websocket element, namely the connection itself and the pre procesed market data.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">global_graficos</span> <span class="kw">&lt;-</span> <span class="fu">reactiveValues</span>(<span class="kw">data</span> <span class="kw">=</span> <span class="kw">NULL</span>)
<span class="no">environment_graficos_iniciar</span> <span class="kw">&lt;-</span> <span class="kw pkg">rlang</span><span class="kw ns">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/env.html">env</a></span>()</pre></body></html></div>
<p>When pressing ‘Iniciar’ two things happen on the server:</p>
<ol style="list-style-type: decimal">
<li>A websocket connection will be created using <a href="https://matbarofex.github.io/rRofex/reference/trading_ws_md.html" target="_blank">trading_ws_md()</a>. This will be the responsible to ingest matket data from the selected instrument.</li>
<li>A reactive data source will be created to read-in the latter.</li>
</ol>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu">observeEvent</span>(<span class="no">input</span>$<span class="no">graficos_iniciar</span>, {
  <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">global_connection</span>$<span class="no">conn</span>)) {
    <span class="fu">sendSweetAlert</span>(<span class="kw">session</span> <span class="kw">=</span> <span class="no">session</span>, <span class="kw">title</span> <span class="kw">=</span> <span class="fu">HTML</span>(<span class="st">"Mmm..."</span>), <span class="kw">text</span> <span class="kw">=</span> <span class="fu">HTML</span>(<span class="st">"Tenes que conectarte primero..."</span>),  <span class="kw">type</span> <span class="kw">=</span> <span class="st">"warning"</span>, <span class="kw">html</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
  } <span class="kw">else</span> {

    <span class="fu"><a href="../reference/trading_ws_md.html">trading_ws_md</a></span>(<span class="kw">connection</span> <span class="kw">=</span> <span class="no">global_connection</span>$<span class="no">conn</span>,
                  <span class="kw">destination</span> <span class="kw">=</span> <span class="st">"data"</span>,
                  <span class="kw">symbol</span> <span class="kw">=</span> <span class="no">input</span>$<span class="no">graficos_producto</span>,
                  <span class="kw">entries</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"LA"</span>),
                  <span class="kw">listen_to</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"LA_price"</span>),
                  <span class="kw">where_is_env</span> <span class="kw">=</span> <span class="no">environment_graficos_iniciar</span>)

    <span class="no">global_graficos</span>$<span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu">reactivePoll</span>(<span class="kw">intervalMillis</span> <span class="kw">=</span> <span class="fl">1000</span>,
                                         <span class="kw">session</span> <span class="kw">=</span> <span class="no">session</span>,
                                         <span class="kw">checkFunc</span> <span class="kw">=</span> <span class="kw">function</span>() {
                                           <span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">environment_graficos_iniciar</span>$<span class="no">data</span>)) <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">environment_graficos_iniciar</span>$<span class="no">data</span>$<span class="no">timestamp</span>)
                                         },
                                         <span class="kw">valueFunc</span> <span class="kw">=</span> <span class="kw">function</span>() {
                                           <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">environment_graficos_iniciar</span>$<span class="no">data</span>)
                                         })
  }
})</pre></body></html></div>
<p>It is important to notice that we are explicitly using the parameter <strong>where_is_env</strong> from <code><a href="../reference/trading_ws_md.html">trading_ws_md()</a></code> function and we are poiting it out to our newly created environment. If we weren’t using this parameter we would have a mixup of data between sessions because each one would be overwriting the global environment. In this away every sesions starts it’s own environment for the websocket elements.</p>
<p>For more information about scoping rules I strongly suggest this reading: <a href="https://shiny.rstudio.com/articles/scoping.html" target="_blank">Scoping rules for Shiny apps</a>.</p>
<p>Once data it’s being acquired we will build and update the plot using the <code>plotly</code> library.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r">  <span class="no">output</span>$<span class="no">graficos_grafico</span> <span class="kw">&lt;-</span> <span class="fu">renderPlotly</span>({
    <span class="kw pkg">shiny</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/validate.html">validate</a></span>(
      <span class="fu">need</span>(<span class="fu">is.reactive</span>(<span class="no">global_graficos</span>$<span class="no">data</span>) <span class="kw">&amp;&amp;</span>
             !<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">global_graficos</span>$<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>()) <span class="kw">&amp;&amp;</span>
             <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">global_graficos</span>$<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>()) <span class="kw">&gt;</span> <span class="fl">0</span>,
           <span class="kw">message</span> <span class="kw">=</span> <span class="st">"Aún no hay data."</span>)
    )
    <span class="fu">plot_ly</span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">global_graficos</span>$<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(),
            <span class="kw">x</span> <span class="kw">=</span> ~<span class="no">LA_date</span>,
            <span class="kw">y</span> <span class="kw">=</span> ~<span class="no">LA_price</span>,
            <span class="kw">mode</span> <span class="kw">=</span> <span class="st">'line'</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/r/graphics/layout.html">layout</a></span>(<span class="kw">title</span> <span class="kw">=</span> <span class="no">input</span>$<span class="no">graficos_producto</span>,
             <span class="kw">xaxis</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Timestamp"</span>),
             <span class="kw">yaxis</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Precio"</span>))
  })</pre></body></html></div>
</div>
<div id="real-time-compute-of-ccl-using-rest-protocol" class="section level5">
<h5 class="hasAnchor">
<a href="#real-time-compute-of-ccl-using-rest-protocol" class="anchor"></a><strong>3. Real time compute of CCL using REST protocol</strong>
</h5>
<p>We start by defining what’s the <strong>CCL</strong> on a function called outside the server scope.</p>
<blockquote>
<p>The CCL is a foreign exchange ratio. It basically tells us how many pesos do we need do buy a single dollar, this by calculating the ratio of the local instrument price and its foreign complement.</p>
</blockquote>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">ccl</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">connection</span>, <span class="no">data</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="fu">glue</span>(<span class="st">"Busco la market data de los {n} productos locales y extranjeros..."</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">data</span>)))
  <span class="no">precio_local</span> <span class="kw">&lt;-</span> <span class="fu">map_df</span>(<span class="kw">.x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(<span class="no">data</span>$<span class="no">Local</span>), <span class="kw">.f</span> <span class="kw">=</span> ~ <span class="fu"><a href="../reference/trading_md.html">trading_md</a></span>(<span class="kw">connection</span> <span class="kw">=</span> <span class="no">connection</span>, <span class="kw">symbol</span> <span class="kw">=</span> <span class="no">.x</span>, <span class="kw">entries</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"LA"</span>, <span class="st">"BI"</span>, <span class="st">"OF"</span>)))
  <span class="no">precio_extranjero</span> <span class="kw">&lt;-</span> <span class="fu">rownames_to_column</span>(<span class="fu">getQuote</span>(<span class="kw">Symbols</span> <span class="kw">=</span> <span class="no">data</span>$<span class="no">Extranjero</span>), <span class="kw">var</span> <span class="kw">=</span> <span class="st">"Symbol"</span>) <span class="kw">%&gt;%</span> <span class="fu">rename</span>(<span class="kw">TradeTime</span> <span class="kw">=</span> <span class="no">`Trade Time`</span>)

  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="fu">glue</span>(<span class="st">"Uno las tablas y calculo el CCL.."</span>))
  <span class="no">data</span> <span class="kw">&lt;-</span> <span class="no">data</span> <span class="kw">%&gt;%</span>
    <span class="fu">left_join</span>(<span class="no">precio_local</span> <span class="kw">%&gt;%</span> <span class="fu">select</span>(<span class="no">Symbol</span>, <span class="no">LA_date</span>, <span class="no">LA_price</span>, <span class="no">BI_price</span>, <span class="no">OF_price</span>), <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Local"</span> <span class="kw">=</span> <span class="st">"Symbol"</span>)) <span class="kw">%&gt;%</span>
    <span class="fu">left_join</span>(<span class="no">precio_extranjero</span> <span class="kw">%&gt;%</span> <span class="fu">select</span>(<span class="no">Symbol</span>, <span class="no">TradeTime</span>, <span class="no">Last</span>), <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Extranjero"</span> <span class="kw">=</span> <span class="st">"Symbol"</span>)) <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(
      <span class="kw">CCL_Last</span> <span class="kw">=</span> (<span class="no">LA_price</span> / <span class="no">Last</span>) * <span class="no">Factor</span>,
      <span class="kw">CCL_Bid</span> <span class="kw">=</span> (<span class="no">BI_price</span> / <span class="no">Last</span>) * <span class="no">Factor</span>,
      <span class="kw">CCL_Offer</span> <span class="kw">=</span> (<span class="no">OF_price</span> / <span class="no">Last</span>) * <span class="no">Factor</span>
    ) <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="kw">.cols</span> <span class="kw">=</span> <span class="fu">starts_with</span>(<span class="st">"CCL_"</span>), <span class="kw">.fns</span> <span class="kw">=</span> ~ <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">.</span> <span class="kw">==</span> <span class="fl">0</span>, <span class="fl">NA_real_</span>, <span class="no">.</span>))) <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(
      <span class="kw">CCL_Last</span> <span class="kw">=</span> <span class="fu">case_when</span>(
        <span class="no">CCL_Last</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/boxplot.stats.html">boxplot.stats</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">.</span>$<span class="no">CCL_Last</span>, <span class="kw">coef</span> <span class="kw">=</span> <span class="fl">3</span>)$<span class="no">out</span> ~ <span class="fl">NA_real_</span>,
        <span class="fl">TRUE</span> ~ <span class="no">CCL_Last</span>
      )
    )

  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">data</span>)
}</pre></body></html></div>
<p>We are obtaining local market data with the function <a href="https://matbarofex.github.io/rRofex/reference/trading_md.html" target="_blank">trading_md()</a> and foreign data it’s being queried with <code>quantomod::getQuote()</code>. As you have probably noticed, there’s a convertion factor that’s beeing appliead to the ratio, this has been defined manually on a dataframe outside the server scope.</p>
<p>Once we have selected the instruments and press ‘Iniciar’, the calculation starts and we are going to see something like this:</p>
<p align="center">
<img src="shiny-rrofex-1.png" width="auto" height="auto" style="max-inline-size: -webkit-fill-available;"></p>
<ul>
<li>A parameter where we can change the refresh frequency of the data</li>
<li>A table that can be downloaded with the processed data</li>
<li>On the right corner we can see the CCL value itself</li>
<li>A plot with the historical value since the we have started the calculations</li>
</ul>
<p>A bit of a hack has been made here in order to update the data:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu">observe</span>({
  <span class="fu">invalidateLater</span>(<span class="kw">millis</span> <span class="kw">=</span> <span class="no">input</span>$<span class="no">table_ccl_timer</span> * <span class="fl">1000</span>, <span class="kw">session</span> <span class="kw">=</span> <span class="no">session</span>)

  <span class="kw">if</span> (<span class="no">input</span>$<span class="no">table_ccl_status</span> <span class="kw">==</span> <span class="fl">TRUE</span>) {
    <span class="kw pkg">shinyjs</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/shinyjs/man/click.html">click</a></span>(<span class="st">"table_ccl_iniciar"</span>)
  }
})</pre></body></html></div>
<p>On this observe we are programmatically clicking the ‘Iniciar’ button with the selected frequency.</p>
</div>
<div id="algorithmic-trading-and-r" class="section level5">
<h5 class="hasAnchor">
<a href="#algorithmic-trading-and-r" class="anchor"></a><strong>4. Algorithmic trading and R</strong>
</h5>
<p>The difference from REST and websocket protcol that I would like to address is that the first one has a uni-directional nature, while the latter has a bi-direction approach. This meaning that we can open a websocket connection and wait for new data to update automatically our feed, while with REST we will have to constantly be querying over and over again if it has been any changes on the data.</p>
<p>The use of websocket in R it’s not very common but we have tried to build a simple interface:</p>
<ul>
<li>When using rRofex in the console we can use the family <code>trading_ws_*</code> to open websocket connections and query market data, look up state of our orders and close connections</li>
<li>When using rRofex on Shiny the main difference is to create a self contain environment where the connection is going to live and then passing it on into the <strong>where_is_env</strong> parameter.</li>
</ul>
<blockquote>
<p>We have build a test algorithm that works in this way: <em>every time new market data is received we put an offer and a bid improving, by the minimun amount, the first line on the order book. By doing this, we try to stay on top of the order book every time.</em></p>
</blockquote>
<p>This is a simple yey powerfull example. We have called it ‘The Molesto’.</p>
<p>Listing to market data is pretty much the same as what we have done within the ploting example, so I want to focus on the algorithm itself.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu">observe</span>({

  <span class="fu">req</span>(!<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">global_algoritmos_1</span>$<span class="no">data</span>))
  <span class="fu">req</span>(<span class="no">global_algoritmos_1</span>$<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>())

  <span class="no">logger_algoritmos_1</span> <span class="kw">&lt;-</span> <span class="fu">create.logger</span>(<span class="kw">logfile</span> <span class="kw">=</span> <span class="fu">glue</span>(<span class="st">"logs/the_molesto_{input$algoritmos_1_producto}_{Sys.Date()}.log"</span>), <span class="kw">level</span> <span class="kw">=</span> <span class="st">"INFO"</span>)

  <span class="co"># Objectivo: colocar una punta molesta, en el bid o en el ask cada vez que cambia el size en cualquiera de los casos</span>

  <span class="fu">isolate</span>({

    <span class="no">market_data</span> <span class="kw">&lt;-</span> <span class="no">global_algoritmos_1</span>$<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>()
    <span class="no">productos</span> <span class="kw">&lt;-</span> <span class="fu">global_productos</span>()

    <span class="no">global_algoritmos_1_ordenes</span>$<span class="no">MinTradeVol</span> <span class="kw">&lt;-</span> <span class="no">productos</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">Symbol</span> <span class="kw">==</span> <span class="no">input</span>$<span class="no">algoritmos_1_producto</span>) <span class="kw">%&gt;%</span> <span class="fu">pull</span>(<span class="no">MinTradeVol</span>)
    <span class="no">global_algoritmos_1_ordenes</span>$<span class="no">MinPriceIncrement</span> <span class="kw">&lt;-</span> <span class="no">productos</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">Symbol</span> <span class="kw">==</span> <span class="no">input</span>$<span class="no">algoritmos_1_producto</span>) <span class="kw">%&gt;%</span> <span class="fu">pull</span>(<span class="no">MinPriceIncrement</span>)

    <span class="kw">if</span> (<span class="fu">some</span>(<span class="kw">.x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"BI_price"</span>, <span class="st">"BI_size"</span>), <span class="kw">.p</span> <span class="kw">=</span> ~ <span class="no">.</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span>(<span class="no">market_data</span>$<span class="no">Changes</span>, <span class="st">","</span>))) <span class="kw">&amp;&amp;</span>
        <span class="fu">every</span>(<span class="kw">.x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"BI_price"</span>, <span class="st">"BI_size"</span>), <span class="kw">.p</span> <span class="kw">=</span> ~ <span class="no">.</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">market_data</span>)) <span class="kw">&amp;&amp;</span>
        !<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">market_data</span>$<span class="no">BI_price</span>)) {

      <span class="fu">info</span>(<span class="no">logger_algoritmos_1</span>, <span class="fu">str_c</span>(<span class="st">"- [BID] Cambia la punta compradora"</span>))

      <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">global_algoritmos_1_ordenes</span>$<span class="no">Bid</span>)) {

        <span class="no">bid</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/trading_new_order.html">trading_new_order</a></span>(<span class="kw">connection</span> <span class="kw">=</span> <span class="no">global_connection</span>$<span class="no">conn</span>,
                                 <span class="kw">account</span>  <span class="kw">=</span> <span class="no">input</span>$<span class="no">algoritmos_1_cuenta</span>,
                                 <span class="kw">symbol</span>   <span class="kw">=</span> <span class="no">input</span>$<span class="no">algoritmos_1_producto</span>,
                                 <span class="kw">side</span>     <span class="kw">=</span> <span class="st">"Buy"</span>,
                                 <span class="kw">quantity</span> <span class="kw">=</span> <span class="no">global_algoritmos_1_ordenes</span>$<span class="no">MinTradeVol</span>,
                                 <span class="kw">price</span>    <span class="kw">=</span> <span class="no">market_data</span>$<span class="no">BI_price</span> + <span class="no">global_algoritmos_1_ordenes</span>$<span class="no">MinPriceIncrement</span>)

        <span class="no">global_algoritmos_1_ordenes</span>$<span class="no">Bid</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/append.html">append</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">global_algoritmos_1_ordenes</span>$<span class="no">Bid</span>, <span class="kw">values</span> <span class="kw">=</span> <span class="no">bid</span>$<span class="no">clOrdId</span>)
        <span class="no">global_algoritmos_1_ordenes</span>$<span class="no">BidPrice</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/append.html">append</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">global_algoritmos_1_ordenes</span>$<span class="no">BidPrice</span>, <span class="kw">values</span> <span class="kw">=</span> <span class="no">bid</span>$<span class="no">price</span>)

        <span class="fu">info</span>(<span class="no">logger_algoritmos_1</span>, <span class="fu">glue</span>(<span class="st">"- [BID] Primer compra - {price} - {status}"</span>,
                                       <span class="kw">price</span> <span class="kw">=</span> <span class="no">bid</span>$<span class="no">price</span>,
                                       <span class="kw">status</span> <span class="kw">=</span> <span class="no">bid</span>$<span class="no">status</span>))
      } <span class="kw">else</span> {

        <span class="kw">if</span> (<span class="no">market_data</span>$<span class="no">BI_price</span> <span class="kw">==</span> <span class="fu">last</span>(<span class="no">global_algoritmos_1_ordenes</span>$<span class="no">BidPrice</span>) <span class="kw">&amp;&amp;</span>
            <span class="no">market_data</span>$<span class="no">BI_size</span> <span class="kw">==</span> <span class="no">global_algoritmos_1_ordenes</span>$<span class="no">MinTradeVol</span>) {

          <span class="fu">info</span>(<span class="no">logger_algoritmos_1</span>, <span class="fu">glue</span>(<span class="st">"- [BID] No juego (soy yo)"</span>))

        } <span class="kw">else</span> {

          <span class="no">bid</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/trading_new_order.html">trading_new_order</a></span>(<span class="kw">connection</span> <span class="kw">=</span> <span class="no">global_connection</span>$<span class="no">conn</span>,
                                   <span class="kw">account</span>  <span class="kw">=</span> <span class="no">input</span>$<span class="no">algoritmos_1_cuenta</span>,
                                   <span class="kw">symbol</span>   <span class="kw">=</span> <span class="no">input</span>$<span class="no">algoritmos_1_producto</span>,
                                   <span class="kw">side</span>     <span class="kw">=</span> <span class="st">"Buy"</span>,
                                   <span class="kw">quantity</span> <span class="kw">=</span> <span class="no">global_algoritmos_1_ordenes</span>$<span class="no">MinTradeVol</span>,
                                   <span class="kw">price</span>    <span class="kw">=</span> <span class="no">market_data</span>$<span class="no">BI_price</span> + <span class="no">global_algoritmos_1_ordenes</span>$<span class="no">MinPriceIncrement</span>)

          <span class="no">global_algoritmos_1_ordenes</span>$<span class="no">Bid</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/append.html">append</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">global_algoritmos_1_ordenes</span>$<span class="no">Bid</span>, <span class="kw">values</span> <span class="kw">=</span> <span class="no">bid</span>$<span class="no">clOrdId</span>)
          <span class="no">global_algoritmos_1_ordenes</span>$<span class="no">BidPrice</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/append.html">append</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">global_algoritmos_1_ordenes</span>$<span class="no">BidPrice</span>, <span class="kw">values</span> <span class="kw">=</span> <span class="no">bid</span>$<span class="no">price</span>)

          <span class="fu"><a href="../reference/trading_cancel_order.html">trading_cancel_order</a></span>(<span class="kw">connection</span> <span class="kw">=</span> <span class="no">global_connection</span>$<span class="no">conn</span>, <span class="kw">id</span> <span class="kw">=</span> <span class="fu">nth</span>(<span class="no">global_algoritmos_1_ordenes</span>$<span class="no">Bid</span>, -<span class="fl">2</span>), <span class="kw">proprietary</span> <span class="kw">=</span> <span class="st">"PBCP"</span>)

          <span class="fu">info</span>(<span class="no">logger_algoritmos_1</span>, <span class="fu">glue</span>(<span class="st">"- [BID] Molesto - {price} - {status}"</span>,
                                         <span class="kw">price</span> <span class="kw">=</span> <span class="no">bid</span>$<span class="no">price</span>,
                                         <span class="kw">status</span> <span class="kw">=</span> <span class="no">bid</span>$<span class="no">status</span>))
        }
      }
    }
  })
})</pre></body></html></div>
<p>We are only looking at the bid side just because the offer side works the same.</p>
<p>We can see that mostly everything has been wrapped up into an isolate function, this avoids to make build an infinite loop every time some new data entered into the algorithm. <strong>This is the most important thing to remember</strong>, everything else are just simple ‘if and else’ with the logic of what we have to do every time new data has been presented.</p>
<p>Anyone can test this algorithm by putting their own credentials from the test environment reMarkets. You can generate them <a href="https://remarkets.primary.ventures/" target="_blank">here</a>.</p>
<p>This is how it looks when the algorithm starts:</p>
<p align="center">
<img src="shiny-rrofex-2.png" width="auto" height="auto" style="max-inline-size: -webkit-fill-available;"></p>
</div>
</div>
<div id="closing-remarks" class="section level4">
<h4 class="hasAnchor">
<a href="#closing-remarks" class="anchor"></a>Closing remarks</h4>
<p>Again, this was not suppose to be an indepth guide on how to build a Shiny app, nor how to code algortithms for trading. Instead, this was only an atempt to show some use cases of the rRofex library within Shiny and to encourage those who want to use R on the financial markets. <em>It is my hope that anyone that have seen this application could get some inspiration while building their own path.</em></p>
<p>Let’s stay in touch!</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Augusto Hassel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
